<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>订单拍摄控制 - 合伙人管理端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#60A5FA',
                        accent: '#2563EB',
                        dark: '#1E293B',
                        light: '#F8FAFC',
                        'gray-medium': '#64748B',
                        'gray-light': '#E2E8F0',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444'
                    },
                    fontFamily: {
                        inter: ['Inter', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .touch-friendly {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }
            .miniprogram-card {
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                border-radius: 8px;
            }
            .progress-bar {
                transition: width 0.3s ease;
            }
            .pulse-animation {
                animation: pulse 2s ease-in-out infinite alternate;
            }
            @keyframes pulse {
                from { opacity: 1; }
                to { opacity: 0.5; }
            }
        }
    </style>
</head>
<body class="font-inter bg-light text-dark antialiased">
    <div class="min-h-screen w-full">
        <!-- 顶部导航栏 -->
        <nav class="bg-white border-b border-gray-light px-4 py-3">
            <div class="flex items-center justify-between">
                <button onclick="history.back()" class="touch-friendly">
                    <i class="fa fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-lg font-medium">订单拍摄控制</h1>
                <button id="emergency-stop" class="px-3 py-1 bg-danger text-white rounded text-sm touch-friendly">
                    紧急停止
                </button>
            </div>
        </nav>

        <div class="p-4 space-y-4">
            <!-- 订单信息卡片 -->
            <div class="miniprogram-card bg-white p-4">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h2 class="text-lg font-medium" id="order-id">ORD001</h2>
                        <p class="text-gray-medium text-sm" id="customer-info">王先生 · 138****1234</p>
                    </div>
                    <span id="order-status" class="px-3 py-1 bg-warning/10 text-warning rounded-full text-sm">
                        拍摄中
                    </span>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-medium">拍摄地点：</span>
                        <span id="location">摩崖石刻</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-medium">订单金额：</span>
                        <span id="amount" class="font-medium">¥240</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-medium">拍摄时间：</span>
                        <span id="shoot-time">10:30</span>
                    </div>
                </div>
            </div>

            <!-- 拍摄进度 -->
            <div class="miniprogram-card bg-white p-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-medium">拍摄进度</h3>
                    <span id="progress-text" class="text-sm text-gray-medium">2/3 个样片</span>
                </div>
                <div class="w-full bg-gray-light rounded-full h-2 mb-3">
                    <div id="progress-bar" class="bg-primary h-2 rounded-full progress-bar" style="width: 66%"></div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 bg-success/5 rounded">
                        <div class="flex items-center">
                            <i class="fa fa-check-circle text-success mr-2"></i>
                            <span class="text-sm">航拍全景</span>
                        </div>
                        <span class="text-xs text-success">已完成</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-primary/5 rounded pulse-animation">
                        <div class="flex items-center">
                            <i class="fa fa-circle-o-notch fa-spin text-primary mr-2"></i>
                            <span class="text-sm">人物特写</span>
                        </div>
                        <span class="text-xs text-primary">拍摄中</span>
                    </div>
                    <div class="flex items-center justify-between p-2 bg-gray-light/50 rounded">
                        <div class="flex items-center">
                            <i class="fa fa-clock-o text-gray-medium mr-2"></i>
                            <span class="text-sm">环绕飞行</span>
                        </div>
                        <span class="text-xs text-gray-medium">等待中</span>
                    </div>
                </div>
            </div>

            <!-- 实时画面预览 -->
            <div class="miniprogram-card bg-white p-4">
                <h3 class="font-medium mb-3">实时画面</h3>
                <div class="relative aspect-video bg-black rounded-lg overflow-hidden">
                    <img id="live-preview" src="https://picsum.photos/id/1015/800/450" alt="实时预览" class="w-full h-full object-cover">
                    <div class="absolute top-2 left-2 px-2 py-1 bg-danger text-white text-xs rounded">
                        <i class="fa fa-circle mr-1"></i>LIVE
                    </div>
                    <div class="absolute top-2 right-2 px-2 py-1 bg-black/50 text-white text-xs rounded">
                        <i class="fa fa-clock-o mr-1"></i><span id="recording-time">02:15</span>
                    </div>
                    <div class="absolute bottom-2 left-2 text-white text-xs bg-black/50 px-2 py-1 rounded">
                        高度: <span id="altitude">15m</span>
                    </div>
                    <div class="absolute bottom-2 right-2 text-white text-xs bg-black/50 px-2 py-1 rounded">
                        速度: <span id="speed">5m/s</span>
                    </div>
                </div>
            </div>

            <!-- 无人机状态监控 -->
            <div class="miniprogram-card bg-white p-4">
                <h3 class="font-medium mb-3">飞行状态</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-success" id="battery-level">78%</div>
                        <div class="text-xs text-gray-medium">电池电量</div>
                        <div class="w-full bg-gray-light rounded-full h-1 mt-1">
                            <div class="bg-success h-1 rounded-full" style="width: 78%"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-primary" id="signal-strength">-65dBm</div>
                        <div class="text-xs text-gray-medium">信号强度</div>
                        <div class="flex justify-center mt-1">
                            <i class="fa fa-signal text-primary"></i>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-accent" id="gps-count">18</div>
                        <div class="text-xs text-gray-medium">GPS卫星</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold text-warning" id="wind-speed">2.1m/s</div>
                        <div class="text-xs text-gray-medium">风速</div>
                    </div>
                </div>
            </div>

            <!-- 控制按钮 -->
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <button id="pause-btn" class="miniprogram-card bg-white p-4 text-center touch-friendly">
                        <i class="fa fa-pause text-2xl text-warning mb-2"></i>
                        <div class="text-sm font-medium">暂停拍摄</div>
                    </button>
                    <button id="return-btn" class="miniprogram-card bg-white p-4 text-center touch-friendly">
                        <i class="fa fa-home text-2xl text-secondary mb-2"></i>
                        <div class="text-sm font-medium">返回起点</div>
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="hover-btn" class="miniprogram-card bg-white p-4 text-center touch-friendly">
                        <i class="fa fa-hand-paper-o text-2xl text-accent mb-2"></i>
                        <div class="text-sm font-medium">悬停等待</div>
                    </button>
                    <button id="next-sample-btn" class="miniprogram-card bg-primary text-white p-4 text-center touch-friendly">
                        <i class="fa fa-play text-2xl mb-2"></i>
                        <div class="text-sm font-medium">下一样片</div>
                    </button>
                </div>
                
                <button id="complete-btn" class="w-full miniprogram-card bg-success text-white p-4 text-center touch-friendly">
                    <i class="fa fa-check text-xl mr-2"></i>完成拍摄
                </button>
            </div>

            <!-- 客户联系 -->
            <div class="miniprogram-card bg-gradient-to-r from-secondary to-secondary/80 text-white p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium">客户联系</div>
                        <div class="text-white/90 text-sm">有问题及时沟通</div>
                    </div>
                    <button id="call-customer" class="px-4 py-2 bg-white/20 rounded-lg touch-friendly">
                        <i class="fa fa-phone mr-1"></i>拨打电话
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 紧急停止确认弹窗 -->
    <div id="emergency-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 m-4 max-w-sm w-full">
            <div class="text-center">
                <i class="fa fa-exclamation-triangle text-4xl text-danger mb-3"></i>
                <h3 class="text-lg font-bold mb-2">紧急停止</h3>
                <p class="text-gray-medium text-sm mb-4">确认要紧急停止无人机并召回吗？此操作会中断当前拍摄。</p>
                <div class="flex space-x-3">
                    <button id="cancel-emergency" class="flex-1 py-2 border border-gray-light rounded-lg touch-friendly">
                        取消
                    </button>
                    <button id="confirm-emergency" class="flex-1 py-2 bg-danger text-white rounded-lg touch-friendly">
                        确认停止
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 完成拍摄确认弹窗 -->
    <div id="complete-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 m-4 max-w-sm w-full">
            <div class="text-center">
                <i class="fa fa-check-circle text-4xl text-success mb-3"></i>
                <h3 class="text-lg font-bold mb-2">完成拍摄</h3>
                <p class="text-gray-medium text-sm mb-4">所有样片已拍摄完成，确认结束本次拍摄任务吗？</p>
                <div class="flex space-x-3">
                    <button id="cancel-complete" class="flex-1 py-2 border border-gray-light rounded-lg touch-friendly">
                        继续拍摄
                    </button>
                    <button id="confirm-complete" class="flex-1 py-2 bg-success text-white rounded-lg touch-friendly">
                        确认完成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class OrderControlApp {
            constructor() {
                this.orderId = 'ORD001';
                this.isRecording = true;
                this.recordingStartTime = Date.now();
                this.currentSample = 2;
                this.totalSamples = 3;
                this.init();
            }

            init() {
                this.initEventListeners();
                this.addTouchFeedback();
                this.startRecordingTimer();
                this.loadOrderInfo();
            }

            initEventListeners() {
                // 紧急停止
                document.getElementById('emergency-stop').addEventListener('click', this.showEmergencyModal.bind(this));
                document.getElementById('cancel-emergency').addEventListener('click', this.hideEmergencyModal.bind(this));
                document.getElementById('confirm-emergency').addEventListener('click', this.emergencyStop.bind(this));

                // 完成拍摄
                document.getElementById('complete-btn').addEventListener('click', this.showCompleteModal.bind(this));
                document.getElementById('cancel-complete').addEventListener('click', this.hideCompleteModal.bind(this));
                document.getElementById('confirm-complete').addEventListener('click', this.completeShooting.bind(this));

                // 控制按钮
                document.getElementById('pause-btn').addEventListener('click', this.pauseShooting.bind(this));
                document.getElementById('return-btn').addEventListener('click', this.returnToBase.bind(this));
                document.getElementById('hover-btn').addEventListener('click', this.hoverWait.bind(this));
                document.getElementById('next-sample-btn').addEventListener('click', this.nextSample.bind(this));
                document.getElementById('call-customer').addEventListener('click', this.callCustomer.bind(this));
            }

            addTouchFeedback() {
                document.querySelectorAll('.touch-friendly').forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.style.opacity = '0.7';
                        this.style.transform = 'scale(0.98)';
                    });
                    
                    element.addEventListener('touchend', function() {
                        this.style.opacity = '1';
                        this.style.transform = 'scale(1)';
                    });
                    
                    element.addEventListener('touchcancel', function() {
                        this.style.opacity = '1';
                        this.style.transform = 'scale(1)';
                    });
                });
            }

            loadOrderInfo() {
                // 模拟从URL参数或localStorage获取订单信息
                const orderInfo = {
                    id: 'ORD001',
                    customer: '王先生',
                    phone: '138****1234',
                    location: '摩崖石刻',
                    amount: '¥240',
                    time: '10:30'
                };

                document.getElementById('order-id').textContent = orderInfo.id;
                document.getElementById('customer-info').textContent = `${orderInfo.customer} · ${orderInfo.phone}`;
                document.getElementById('location').textContent = orderInfo.location;
                document.getElementById('amount').textContent = orderInfo.amount;
                document.getElementById('shoot-time').textContent = orderInfo.time;
            }

            startRecordingTimer() {
                setInterval(() => {
                    if (this.isRecording) {
                        const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                        const seconds = (elapsed % 60).toString().padStart(2, '0');
                        document.getElementById('recording-time').textContent = `${minutes}:${seconds}`;
                    }
                }, 1000);

                // 模拟实时数据更新
                setInterval(() => {
                    this.updateFlightData();
                }, 2000);
            }

            updateFlightData() {
                // 模拟飞行数据变化
                const altitude = Math.floor(Math.random() * 10 + 10);
                const speed = (Math.random() * 3 + 2).toFixed(1);
                const battery = Math.max(70, Math.floor(Math.random() * 15 + 70));
                const wind = (Math.random() * 2 + 1).toFixed(1);

                document.getElementById('altitude').textContent = `${altitude}m`;
                document.getElementById('speed').textContent = `${speed}m/s`;
                document.getElementById('battery-level').textContent = `${battery}%`;
                document.getElementById('wind-speed').textContent = `${wind}m/s`;

                // 更新电池进度条
                const batteryBar = document.querySelector('#battery-level').nextElementSibling.nextElementSibling.firstElementChild;
                batteryBar.style.width = `${battery}%`;
            }

            showEmergencyModal() {
                document.getElementById('emergency-modal').classList.remove('hidden');
            }

            hideEmergencyModal() {
                document.getElementById('emergency-modal').classList.add('hidden');
            }

            emergencyStop() {
                this.hideEmergencyModal();
                this.isRecording = false;
                alert('紧急停止指令已发送，无人机正在返回');
                // 这里应该发送实际的停止指令
                setTimeout(() => {
                    history.back();
                }, 2000);
            }

            showCompleteModal() {
                document.getElementById('complete-modal').classList.remove('hidden');
            }

            hideCompleteModal() {
                document.getElementById('complete-modal').classList.add('hidden');
            }

            completeShooting() {
                this.hideCompleteModal();
                this.isRecording = false;
                alert('拍摄已完成，正在生成视频');
                // 这里应该触发视频生成流程
                setTimeout(() => {
                    history.back();
                }, 1500);
            }

            pauseShooting() {
                this.isRecording = !this.isRecording;
                const btn = document.getElementById('pause-btn');
                const icon = btn.querySelector('i');
                const text = btn.querySelector('div');
                
                if (this.isRecording) {
                    icon.className = 'fa fa-pause text-2xl text-warning mb-2';
                    text.textContent = '暂停拍摄';
                } else {
                    icon.className = 'fa fa-play text-2xl text-success mb-2';
                    text.textContent = '继续拍摄';
                }
            }

            returnToBase() {
                alert('无人机正在返回起点');
            }

            hoverWait() {
                alert('无人机已切换为悬停模式');
            }

            nextSample() {
                if (this.currentSample < this.totalSamples) {
                    this.currentSample++;
                    this.updateProgress();
                    alert('开始拍摄下一个样片');
                } else {
                    alert('所有样片已完成');
                }
            }

            updateProgress() {
                const progress = (this.currentSample / this.totalSamples) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
                document.getElementById('progress-text').textContent = `${this.currentSample}/${this.totalSamples} 个样片`;
            }

            callCustomer() {
                const phone = '13812341234'; // 从订单信息获取
                if (typeof wx !== 'undefined') {
                    wx.makePhoneCall({
                        phoneNumber: phone
                    });
                } else {
                    window.open(`tel:${phone}`);
                }
            }
        }

        // 初始化应用
        const controlApp = new OrderControlApp();
    </script>
</body>
</html>
